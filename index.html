<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- cssã‚’ç´ã¥ã‘ã¾ã—ãŸ -->
    <link rel="stylesheet" href="css/style.css">

    <!-- ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚’ã™ã‚‹ãŸã‚ã«ç´ã¥ã‘ã¾ã—ãŸ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    
</head>

<body>
    <!-- firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹ç®± -->
    <div id="output">

    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹ç®± -->
    <div class="usercontents">

        <!-- åå‰ã‚’å…¥åŠ› -->
        <div class="userInfo">
            <p class="userNameText">åå‰</p>
            <input type="text" id="username">
        </div>

        <!-- å†…å®¹ã‚’å…¥åŠ› -->
        <div class="chatContents">
            <p class="chattext">å†…å®¹</p>
            <textarea id="chatInput" cols="30" rows="1"></textarea>
            <button   id="send" class="far fa-paper-plane"></button>
        </div>
        
    </div>




    <!-- jqueryã®ç´ã¥ã‘ã‚’ã—ã¾ã—ãŸ -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- jsã‚’ç´ä»˜ã‘ã‚’ã—ã¾ã—ãŸ -->
    <script src="js/work.js"> </script>
    

    <!-- firebseã‚’ç´ã¥ã‘ã¾ã—ãŸï¼ˆCDNï¼‰ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        // onChildChangedã‚’è¿½åŠ ã—ã¾ã—ãŸ
        import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildRemoved, onChildChanged }
            from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
        
        // Your web app's Firebase configuration
        

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // dbã¸ã®æ¥ç¶š
        const db  = getDatabase(app)
        // éšå±¤ã‚’ä½œæˆã™ã‚‹
        const dbRef = ref(db, "chat");

        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™
        // ãƒ‡ãƒ¼ã‚¿ã‚’htmlã‹ã‚‰å–ã‚‹â†’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆå¡Šï¼‰ã«ã™ã‚‹â†’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’firebaseã«é€ã‚‹â†’htmlã‚’æ¶ˆã™
        $("#send").on('click',function(){
        
            const username  = $("#username").val();
            const chatinput = $("#chatInput").val();

            const msg = {
                username:  username,
                text:      chatinput,
            }

            const newPostRef = push(dbRef);
            set(newPostRef,msg);

            $("#username").val("");
            $("#chatInput").val("");
        });

        onChildAdded(dbRef,function(date){

            // keyã¯æ›´æ–°ã¨å‰Šé™¤ã«ã‚Šã‚ˆã†ã™ã‚‹
            const key = date.key;
            const msg = date.val();
            
            // ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã§ç´°ã‹ãå®šç¾©ãŒã§ãã¦ç·¨é›†ã—ã‚„ã™ã„
            let h = '<p id="' + key + '">';
                h += msg.username;
                h += '<br>';
                h += '<span contentEditable="true" id="' + key + '_update">' + msg.text + '</span>';
                h += '<span class="update" data-key="' + key + '">ğŸ†™</span>'
                h += '<span class="remove" data-key="' + key + '">ğŸ—‘</span>'
                h += '</p>';

            $("#output").append(h);
        })

        //firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        $("#output").on("click", ".remove", function(){
            const key = $(this).attr("data-key");
            const remove_item = ref(db, "chat/"+key);
            remove(remove_item); //Firebaseã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
        });

        //firebaseã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        $("#output").on("click", ".update", function(){
            const key = $(this).attr("data-key");
            update(ref(db, "chat/"+key), {
                text: $("#"+key+'_update').html()
            });
        });

        //firebaseã§ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ãŒã•ã‚ŒãŸã‚‰htmlã«åæ˜ 
        onChildRemoved(dbRef, (data) => {
            $("#" + data.key).remove(); //DOMæ“ä½œå‰Šé™¤ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
        });

        //firebaseã§ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ãŒã•ã‚ŒãŸã‚‰htmlã«åæ˜ 
        onChildChanged(dbRef, (data) => {
            $("#" + data.key + '_update').html(data.val().text);
            $("#" + data.key + '_update').fadeOut(1000).fadeIn(1000);
        });

        //æ–°è¦ç™»éŒ²å‡¦ç†
        register.addEventListener('click', function(e) {
            var mailAddress = document.getElementById('mailAddress').value;
            var password = document.getElementById('password').value;
    
            firebase.auth().createUserWithEmailAndPassword(mailAddress, password)
            .catch(function(error) {
            alert('ç™»éŒ²ã§ãã¾ã›ã‚“ï¼ˆ' + error.message + 'ï¼‰');
            });
        });
      </script>
      
</body>
</html>